<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2429LYJSNH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2429LYJSNH');
  </script>

  <meta charset="UTF-8">
  <title>IESE I3E Economic Uncertainty Index | IESE Business School Global Uncertainty Indicator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="The I3E Economic Uncertainty Index measures and compares economic uncertainty in major economies worldwide. Updated daily, unbiased and transparent.">
  <meta name="keywords" content="I3E, Economic Uncertainty, Uncertainty Index, Economic Risk, IESE, Economic Indicators, International Center for Decision Making, Global Economic Index, Research, Data">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://i3e-index.github.io/">
  
  <!-- âœ… Favicons (Absolute URLs for Google & Safari) -->
  <link rel="icon" href="https://i3e-index.github.io/favicon.png?v=2" sizes="48x48" type="image/png">
  <link rel="icon" href="https://i3e-index.github.io/favicon.ico?v=2" sizes="any">
  <link rel="apple-touch-icon" href="https://i3e-index.github.io/favicon.png?v=2">
  <link rel="mask-icon" href="https://i3e-index.github.io/mask-icon.svg" color="#FF3B30">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="IESE I3E Economic Uncertainty Index">
  <meta property="og:description" content="Track economic uncertainty globally with the I3E Index. Daily updates, transparent methodology, downloadable data for researchers and decision-makers">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://i3e-index.github.io/">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="IESE I3E Economic Uncertainty Index">
  <meta name="twitter:description" content="Explore global economic uncertainty with I3E's transparent and up-to-date index.">
  
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "I3E Economic Uncertainty Index",
    "url": "https://i3e-index.github.io/",
    "logo": "https://i3e-index.github.io/favicon.png",
    "description": "The I3E Economic Uncertainty Index is an unbiased, daily-updated measure of global and national economic uncertainty, powered by IESE Business School and the International Center for Decision Making.",
    "publisher": {
      "@type": "Organization",
      "name": "IESE Business School",
      "url": "https://www.iese.edu"
    }
  }
  </script>

  <!-- Load Plotly and Custom Charts -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- ðŸ”§ Shim: force responsive plots + immediate resize after newPlot
     â€” also set default x-axis view to last 10 years if no range provided -->
  <script>
    (function () {
      ...
    })();
  </script>
  
  <script src="charts.js"></script>

  <style>
    html, body { margin: 0; padding: 0; }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #ffffff;
      display: flex;
    }
    .sidebar {
      width: 120px;
      flex-shrink: 0;
      background-color: #f4f4f4;
      padding: 0px 10px 10px 10px;
      height: 100vh;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    .sidebar h2 { font-size: 16px; margin-top: 0; margin-bottom: 8px; }
    .sidebar a {
      display: block;
      padding: 4px 8px;
      color: #333;
      text-decoration: none;
      margin-bottom: 2px;
      font-size: 14px;
    }
    .sidebar a:hover { background-color: #FF3B30; color: white; }
    .main {
      flex-grow: 1;
      max-width: 1700px;
      margin: 0 20px 20px 0;
      padding: 20px;
    }
    .header {
      background-color: #FF3B30;
      color: white;
      padding: 10px 20px;
      margin-left: 0.01px;
      box-sizing: border-box;
      max-width: 1500px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-top .title, .header-top .icdm { font-size: 16px; font-weight: bold; }
    .header-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .nav a {
      display: inline-block;
      color: white;
      text-align: center;
      text-decoration: none;
      margin-right: 30px;
      font-size: 16px;
      line-height: 16px;
    }
    .business { font-size: 16px; line-height: 20px; }

    .content-wrapper {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 40px;
      margin-top: 20px;
    }
    .content {
      flex: 0 1 67%;
      text-align: justify;
      font-size: 13px;
    }
    .content p, .content li { font-size: 15px; }
    #table-container { min-width: 200px; }
    #table-container table, #subindex-table-container table {
      width: 100%;
      border-collapse: collapse;
      border: none;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 20px;
    }
    #table-container th, #table-container td,
    #subindex-table-container th, #subindex-table-container td {
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      border-left: none;
      border-right: none;
      padding: 3px 8px;
      text-align: left;
      white-space: nowrap;
    }
    #table-container th, #subindex-table-container th {
      background-color: #FF3B30;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    h1 { color: #333333; font-size: 18px; }
    h2 { color: #333333; font-size: 16px; }
    p { line-height: 1.6; color: #444; }

    /* Plotly containers */
    .plot-container {
      width: 100%;
      max-width: none;
      height: 60vh;
    }
    .plot-container > .js-plotly-plot,
    .plot-container .plotly,
    .plot-container svg {
      width: 100% !important;
      max-width: 100% !important;
    }

    /* Mobile adjustments */
    @media (max-width: 1000px) {
      .content-wrapper { flex-direction: column; gap: 30px; }
      #table-container { width: 100%; min-width: 0; margin: 0 auto; }
      .content { width: 100%; max-width: 100%; }
    }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }
      .main { margin: 0; padding: 0; max-width: none; }
      .header { max-width: none; margin-left: 0; box-sizing: border-box; }
      .plot-container {
        width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
        height: 70vh;
      }
    }

    /* Subindex tab layout (full width table, text under table) */
    #subindex-view {
      display: none;
      margin-top: 20px;
    }
    #subindex-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    #subindex-text {
      margin-top: 10px;
      font-size: 15px;
      color: #444;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <img src="favicon_XL.png" alt="I3E Economic Uncertainty Index logo" style="display:block; margin:0 auto 18px auto; width:100%; height:auto; max-width:120px;">
    <h2>Countries</h2>
    <a href="#" data-country="global">Global</a>
    <a href="#" data-country="global_weighted">Global Weight</a>
    <a href="#" data-country="australia">Australia</a>
    <a href="#" data-country="austria">Austria</a>
    <a href="#" data-country="belgium">Belgium</a>
    <a href="#" data-country="brazil">Brazil</a>
    <a href="#" data-country="canada">Canada</a>
    <a href="#" data-country="china">China</a>
    <a href="#" data-country="egypt">Egypt</a>
    <a href="#" data-country="france">France</a>
    <a href="#" data-country="germany">Germany</a>
    <a href="#" data-country="greece">Greece</a>
    <a href="#" data-country="israel">Israel</a>
    <a href="#" data-country="italy">Italy</a>
    <a href="#" data-country="japan">Japan</a>
    <a href="#" data-country="mexico">Mexico</a>
    <a href="#" data-country="netherlands">Netherlands</a>
    <a href="#" data-country="poland">Poland</a>
    <a href="#" data-country="south_africa">South Africa</a>
    <a href="#" data-country="south_korea">South Korea</a>
    <a href="#" data-country="spain">Spain</a>
    <a href="#" data-country="turkey">Turkey</a>
    <a href="#" data-country="united_kingdom">United Kingdom</a>
    <a href="#" data-country="united_states">United States</a>
  </div>

  <div class="main">
    <div class="header">
      <div class="header-top">
        <div class="title">IESE I3E Economic Uncertainty Index</div>
        <div class="icdm">International Center for Decision Making (ICDM)</div>
      </div>
      <div class="header-bottom">
        <div class="nav">
          <a href="#" data-tab="home">Home</a>
          <a href="#" data-tab="global-indices">Global Indices</a>
          <a href="#" data-tab="subindex">Subindex</a>
          <a href="#" data-tab="forward">Forward</a>
          <a href="#" data-tab="data">Data</a>
          <a href="#" data-tab="research">Research</a>
          <a href="#" data-tab="contact">Contact</a>
        </div>
        <div class="business">IESE Business School</div>
      </div>
    </div>

    <!-- Home content + home table -->
    <div class="content-wrapper" id="home-view">
      <div class="content" id="content">
        <h1>I3E Economic Uncertainty Index</h1>
        <p>
          The <strong> IESE Economic Uncertainty Index (I3E) </strong> is a daily indicator of economic uncertainty across major world economies.
          Developed by IESE Business School and the International Center for Decision Making, the I3E Index combines stock market volatility, bond yields, exchange rates, and oil prices into a transparent and objective measure.
        </p>
        <p>
          The IESE I3E Economic Uncertainty Index offers a quantifiable and bias-free benchmark for comparing uncertainty levels across nations, providing insight for research and decision-making.
        </p>
        <p>The index is computed daily, using the variation rates of four key variables in each country:</p>
        <ul>
          <li>Domestic Stock Index</li>
          <li>Domestic 10-year government bond yields</li>
          <li>Domestic exchange rate</li>
          <li>International Brent crude oil prices</li>
        </ul>
        <p>
          The index has an average value of 100. Although it can vary across any range, in practice it fluctuates between 0 and 200.
          Values below 100 indicate uncertainty lower than the average of previous decades. Values above 100 indicate greater uncertainty.
        </p>
        <p>
          The <strong>I3E Forward Index</strong> is also computed daily and constructed from the market-expected volatility of these same four variables, measured through the implied volatility of one-month constant-maturity options. 
          This forward-looking measure reflects expectations of economic uncertainty over the next 30 days.
        </p>
        <strong>Learn more:</strong>
        <p><a href="I3E.pdf" target="_blank">I3E Technical Note</a></p>
        <p><a href="I3E_and_alternatives.pdf" target="_blank">Comparison I3E, WUI, EPU, and WIX</a></p>
      </div>

      <div id="table-container"></div>
    </div>

    <!-- Subindex tab view -->
    <div id="subindex-view">
      <div id="subindex-table-wrapper">
        <div id="subindex-table-container"></div>
      </div>
      <div id="subindex-text">
        <strong>Subindex</strong><br>
        This table reports the latest values of the three subcomponents (IDX = Stock Market, Bond = Bond prices, FX = Exchange Rate) for each country, plus Brent subindex.
        Each subcomponent shows the last value and the differences versus 1 day, 1 month, and 1 year ago.
      </div>
    </div>

    <!-- Chart containers -->
    <div id="chart-global" class="plot-container"></div>
    <div id="chart-global_weighted" class="plot-container" style="display:none;"></div>

    <!-- NEW: Forward tab chart container -->
    <div id="chart-forward" class="plot-container" style="display:none;"></div>

    <div id="chart-australia" class="plot-container" style="display:none;"></div>
    <div id="chart-austria" class="plot-container" style="display:none;"></div>
    <div id="chart-belgium" class="plot-container" style="display:none;"></div>
    <div id="chart-brazil" class="plot-container" style="display:none;"></div>
    <div id="chart-canada" class="plot-container" style="display:none;"></div>
    <div id="chart-china" class="plot-container" style="display:none;"></div>
    <div id="chart-egypt" class="plot-container" style="display:none;"></div>
    <div id="chart-france" class="plot-container" style="display:none;"></div>
    <div id="chart-germany" class="plot-container" style="display:none;"></div>
    <div id="chart-greece" class="plot-container" style="display:none;"></div>
    <div id="chart-israel" class="plot-container" style="display:none;"></div>
    <div id="chart-italy" class="plot-container" style="display:none;"></div>
    <div id="chart-japan" class="plot-container" style="display:none;"></div>
    <div id="chart-mexico" class="plot-container" style="display:none;"></div>
    <div id="chart-netherlands" class="plot-container" style="display:none;"></div>
    <div id="chart-poland" class="plot-container" style="display:none;"></div>
    <div id="chart-south_africa" class="plot-container" style="display:none;"></div>
    <div id="chart-south_korea" class="plot-container" style="display:none;"></div>
    <div id="chart-spain" class="plot-container" style="display:none;"></div>
    <div id="chart-turkey" class="plot-container" style="display:none;"></div>
    <div id="chart-united_kingdom" class="plot-container" style="display:none;"></div>
    <div id="chart-united_states" class="plot-container" style="display:none;"></div>
  </div>

  <script>
    // Track which top tab is currently active
    var currentTab = "home";

    // Global date string shown in tabs
    var time = "";

    // Load "time" from i3e_countries.txt (last row date)
    fetch('i3e_countries.txt')
      .then(r => r.text())
      .then(text => {
        let lines = text.trim().split('\n');
        if (lines.length < 2) return;
        let lastLine = lines[lines.length - 1];
        time = lastLine.split('\t')[0].trim();
        loadCountryTable(); // build home table after time loaded
      })
      .catch(err => console.error('Error loading time from country data:', err));

    function formatCountryName(name) {
      return name.replace(/_/g, ' ')
                 .replace(/\b\w/g, c => c.toUpperCase());
    }

    // âœ… HOME TABLE
    function loadCountryTable() {
      fetch('i3e_countries.txt')
        .then(r => r.text())
        .then(text => {
          let lines = text.trim().split('\n');
          if (lines.length < 3) return;

          let headerParts = lines[0].split('\t');
          if (headerParts[0].trim() === '') headerParts.shift();

          // drop date index column for all rows
          let dataRows = lines.slice(1).map(row => row.split('\t').slice(1));
          let lastIdx = dataRows.length - 1;
          let idx30 = dataRows.length - 22;
          let idx365 = dataRows.length - 261;

          const countryBlocks = [
            ["united_states", "canada"],
            ["austria", "belgium", "france", "germany", "greece", "italy", "netherlands", "spain", "poland", "united_kingdom"],
            ["china", "japan", "south_korea", "australia"],
            ["brazil", "mexico"],
            ["israel", "turkey", "egypt", "south_africa"]
          ];
          const globalBlock = ["global", "global_weighted"];

          let countryIndexMap = {};
          headerParts.forEach((name, idx) => {
            countryIndexMap[name.trim().toLowerCase()] = idx;
          });

          let tableHTML = '';
          tableHTML += '<tr><th>Country</th><th>I3E</th><th>Î”1D</th><th>Î”1M</th><th>Î”1Y</th></tr>';

          function coloredDiff(curr, past) {
            let a = parseFloat(curr), b = parseFloat(past);
            if (isNaN(a) || isNaN(b)) return "";
            let d = a - b;
            return d >= 0
              ? `<span style="color:red;">+${d.toFixed(1)}</span>`
              : `<span style="color:green;">${d.toFixed(1)}</span>`;
          }

          countryBlocks.forEach(block => {
            block.forEach((code, countryIdx) => {
              let i = countryIndexMap[code];
              if (i === undefined) return;

              let countryName = formatCountryName(headerParts[i].trim());
              let value = (dataRows[lastIdx][i] || "").trim();
              let prevValue = (dataRows[lastIdx - 1]?.[i] || "").trim();
              let val30 = (idx30 >= 0 ? (dataRows[idx30]?.[i] || "") : "").trim();
              let val365 = (idx365 >= 0 ? (dataRows[idx365]?.[i] || "") : "").trim();

              const isLastInBlock = (countryIdx === block.length - 1);
              const tdStyle = isLastInBlock ? ' style="border-bottom: 2px solid #bbb;"' : '';

              tableHTML += `<tr>
                <td${tdStyle}>${countryName}</td>
                <td${tdStyle}>${value}</td>
                <td${tdStyle}>${coloredDiff(value, prevValue)}</td>
                <td${tdStyle}>${coloredDiff(value, val30)}</td>
                <td${tdStyle}>${coloredDiff(value, val365)}</td>
              </tr>`;
            });
          });

          globalBlock.forEach(code => {
            let i = countryIndexMap[code];
            if (i === undefined) return;

            let countryName = formatCountryName(headerParts[i].trim());
            let value = (dataRows[lastIdx][i] || "").trim();
            let prevValue = (dataRows[lastIdx - 1]?.[i] || "").trim();
            let val30 = (idx30 >= 0 ? (dataRows[idx30]?.[i] || "") : "").trim();
            let val365 = (idx365 >= 0 ? (dataRows[idx365]?.[i] || "") : "").trim();

            tableHTML += `<tr style="font-weight:bold;">
              <td>${countryName}</td>
              <td>${value}</td>
              <td>${coloredDiff(value, prevValue)}</td>
              <td>${coloredDiff(value, val30)}</td>
              <td>${coloredDiff(value, val365)}</td>
            </tr>`;
          });

          let fullHTML =
            `<div style="font-size:14px; margin-bottom:10px;">Date: ${time}<br>I3E: last 1D: Î”1-day 1M: Î”1-month 1Y: Î”1-year</div>
             <table>${tableHTML}</table>`;

          document.getElementById('table-container').innerHTML = fullHTML;
        })
        .catch(err => console.error('Error loading country data:', err));
    }

    // ---------- SUBINDEX TABLE ----------
    function parseTSVDropIndex(text) {
      const lines = text.trim().split('\n').filter(l => l.trim().length > 0);
      if (lines.length < 2) return null;

      let header = lines[0].split('\t');
      if (header[0].trim() === '') header.shift();

      const rows = lines.slice(1).map(line => line.split('\t').slice(1));
      return { header, rows };
    }

    function buildSubindexTable() {
      fetch('subindex.txt')
        .then(r => r.text())
        .then(text => {
          const parsed = parseTSVDropIndex(text);
          if (!parsed) return;

          const header = parsed.header.map(h => h.trim().toLowerCase());
          const rows = parsed.rows;
          const lastIdx = rows.length - 1;
          const idx30 = rows.length - 22;
          const idx365 = rows.length - 261;

          const groups = [
            ["united_states", "canada"],
            ["austria", "belgium", "france", "germany", "greece", "italy", "netherlands", "spain", "poland", "united_kingdom"],
            ["china", "japan", "south_korea", "australia"],
            ["brazil", "mexico"],
            ["israel", "turkey", "egypt", "south_africa"]
          ];
          const globalCountry = "global";

          function colIndex(colName) {
            return header.indexOf(colName.toLowerCase());
          }

          function fmt(x) {
            if (x === null || x === undefined) return "";
            return ("" + x).trim();
          }

          function diffSpan(curr, past, decimals=1) {
            let a = parseFloat(curr), b = parseFloat(past);
            if (isNaN(a) || isNaN(b)) return "";
            let d = a - b;
            return d >= 0
              ? `<span style="color:red;">+${d.toFixed(decimals)}</span>`
              : `<span style="color:green;">${d.toFixed(decimals)}</span>`;
          }

          const brentCol = colIndex("brent");
          const brentLast = brentCol >= 0 ? fmt(rows[lastIdx][brentCol]) : "";
          const brentPrev = brentCol >= 0 ? fmt(rows[lastIdx - 1]?.[brentCol]) : "";
          const brent30  = brentCol >= 0 ? fmt(rows[idx30]?.[brentCol]) : "";
          const brent365 = brentCol >= 0 ? fmt(rows[idx365]?.[brentCol]) : "";

          let html = "";
          html += "<table>";
          html += "<tr>";
          html += "<th>Country</th>";

          const compHeaders = [
            { key: "idx",  label: "IDX"  },
            { key: "bond", label: "Bond" },
            { key: "fx",   label: "FX"   }
          ];

          compHeaders.forEach(c => {
            html += `<th>${c.label}</th><th>Î”1D</th><th>Î”1M</th><th>Î”1Y</th>`;
          });

          html += `<th>Brent</th><th>Î”1D</th><th>Î”1M</th><th>Î”1Y</th>`;
          html += "</tr>";

          function addRow(countryCode, isBold, isEndGroup) {
            const name = formatCountryName(countryCode);
            const trStyle = isBold ? ' style="font-weight:bold;"' : "";
            html += `<tr${trStyle}>`;

            const tdStyle = isEndGroup ? ' style="border-bottom: 2px solid #bbb;"' : "";
            html += `<td${tdStyle}>${name}</td>`;

            compHeaders.forEach(c => {
              const col = colIndex(`${countryCode}_${c.key}`);
              const vLast = col >= 0 ? fmt(rows[lastIdx][col]) : "";
              const vPrev = col >= 0 ? fmt(rows[lastIdx - 1]?.[col]) : "";
              const v30  = col >= 0 ? fmt(rows[idx30]?.[col]) : "";
              const v365 = col >= 0 ? fmt(rows[idx365]?.[col]) : "";

              html += `<td${tdStyle}>${vLast}</td>`;
              html += `<td${tdStyle}>${diffSpan(vLast, vPrev)}</td>`;
              html += `<td${tdStyle}>${diffSpan(vLast, v30)}</td>`;
              html += `<td${tdStyle}>${diffSpan(vLast, v365)}</td>`;
            });

            html += `<td${tdStyle}>${brentLast}</td>`;
            html += `<td${tdStyle}>${diffSpan(brentLast, brentPrev)}</td>`;
            html += `<td${tdStyle}>${diffSpan(brentLast, brent30)}</td>`;
            html += `<td${tdStyle}>${diffSpan(brentLast, brent365)}</td>`;

            html += "</tr>";
          }

          groups.forEach(group => {
            group.forEach((cc, idx) => {
              addRow(cc, false, idx === group.length - 1);
            });
          });

          addRow(globalCountry, true, false);

          html += "</table>";

          const stamp = (time && time.length) ? time : "";
          const headerNote = `<div style="font-size:14px; margin-bottom:10px;">Date: ${stamp}<br>Subindex: last, Î”1-day, Î”1-month, Î”1-year</div>`;
          document.getElementById("subindex-table-container").innerHTML = headerNote + html;
        })
        .catch(err => console.error("Error loading subindex.txt:", err));
    }

    // ---------- FORWARD TAB (IESE FORWARD USA) ----------
    // Uses the SAME chart template/style as charts.js renderChart(), but reading i3e_f_usa.txt
    let forwardCache = { loaded: false, dates: [], values: [], startYear: null, endYear: null };

    function loadForwardData(cb) {
      if (forwardCache.loaded) return cb(forwardCache);

      fetch('i3e_f_usa.txt')
        .then(r => r.text())
        .then(text => {
          const lines = text.trim().split('\n').filter(l => l.trim().length > 0);
          if (lines.length < 2) return;

          // Expect TSV: [index(no name)] \t i3e_f_usa
          const rows = lines.slice(1).map(line => line.split('\t'));
          const dates = rows.map(r => (r[0] || '').trim());
          const values = rows.map(r => parseFloat((r[1] || '').trim()));

          const startYear = new Date(dates[0]).getFullYear();
          const endYear = new Date(dates[dates.length - 1]).getFullYear();

          forwardCache = { loaded: true, dates, values, startYear, endYear };
          cb(forwardCache);
        })
        .catch(err => console.error('Error loading i3e_f_usa.txt:', err));
    }

    function renderForwardChart(containerId) {
      loadForwardData(({ dates, values, startYear, endYear }) => {
        if (!values || !values.length || values.some(v => isNaN(v))) return;

        const latest = values[values.length - 1];
        const latestDate = dates[dates.length - 1];

        const shapes = generateYearLines(startYear, endYear);

        // Thick horizontal line at y = 100 (same as charts.js)
        shapes.push({
          type: "line",
          xref: "paper",
          yref: "y",
          x0: 0,
          x1: 1,
          y0: 100,
          y1: 100,
          line: { color: "#555", width: 1 },
        });

        const chartDiv = document.getElementById(containerId);
        if (!chartDiv) return;

        // EXACT SAME container template style as charts.js (title + subtitle + inner plot div)
        chartDiv.innerHTML = `
          <div class="plot-title" style="text-align:center; font-size:18px;">I3E FORWARD (USA)</div>
          <div class="plot-subtitle" style="text-align:center; font-size:16px;">
            <span class="label">${latestDate}:</span>
            <span class="value">${latest.toFixed(2)}</span>
          </div>
          <div id="${containerId}-plot" style="width: 100%; height: 60vw; max-height: 600px;"></div>
        `;

        // Default window: last 10 years (same logic as charts.js)
        const lastDateObj = new Date(dates[dates.length - 1]);
        const start10Y = new Date(lastDateObj);
        start10Y.setFullYear(start10Y.getFullYear() - 10);

        // âœ… ADD THESE TWO LINES HERE
        const forwardLineColor = "#00BFFF";          // change this to any color
        const forwardFillColor = "rgba(31,119,180,0.06)";

        Plotly.newPlot(
          `${containerId}-plot`,
          [
            {
              x: dates,
              y: values,
              type: "scatter",
              mode: "lines",
              fill: "tozeroy",
              fillcolor: forwardFillColor,
              line: { color: forwardLineColor, width: 2 },
              hovertemplate: "%{x|%Y-%m-%d}<br>Value: %{y}<extra></extra>",
              name: "Forward",
            },
          ],
          {
            margin: { t: 30, b: 40 },
            yaxis: { range: [0, 250], title: "Index Value" },
            xaxis: {
              type: "date",

              // Force initial view to last 10 years
              autorange: false,
              range: [start10Y.toISOString(), lastDateObj.toISOString()],

              tickangle: -90,
              tickformat: "%Y",
              tickvals: Array.from(
                { length: endYear - startYear + 1 },
                (_, i) => `${startYear + i}-01-01`
              ),
              showgrid: false,
              ticks: "outside",
              ticklen: 4,
              tickcolor: "#999",
              rangeselector: {
                active: 3,
                buttons: [
                  { count: 1, label: "1M", step: "month", stepmode: "backward" },
                  { count: 12, label: "1Y", step: "month", stepmode: "backward" },
                  { count: 60, label: "5Y", step: "month", stepmode: "backward" },
                  { count: 120, label: "10Y", step: "month", stepmode: "backward" },
                  { step: "all", label: "MAX" },
                ],
              },
            },
            shapes: shapes,
            hovermode: "x unified",
            plot_bgcolor: "white",
            dragmode: false,
          },
          {
            displayModeBar: false,
            scrollZoom: false,
            doubleClick: false,
            staticPlot: false,
            responsive: true,
          }
        );
      });
    }

    // ---------- NAV TABS ----------
    function hideAllCharts() {
      document.querySelectorAll('.plot-container').forEach(div => div.style.display = 'none');
    }

    function showSubindex() {
      document.getElementById('home-view').style.display = 'none';
      hideAllCharts();
      document.getElementById('subindex-view').style.display = 'block';
      buildSubindexTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showForward() {
      document.getElementById('subindex-view').style.display = 'none';
      document.getElementById('home-view').style.display = 'none';
      hideAllCharts();

      const chartDiv = document.getElementById('chart-forward');
      if (chartDiv) {
     
        chartDiv.style.display = 'block';
        renderForwardChart('chart-forward');

        if (window.Plotly) {
          setTimeout(() => { try { Plotly.Plots.resize(chartDiv); } catch(e) {} }, 0);
        }
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.querySelectorAll('.nav a[data-tab]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const tab = this.getAttribute('data-tab');
        currentTab = tab;

        const contentDiv = document.getElementById('content');
        const tableDiv = document.getElementById('table-container');

        if (tab === 'home') {
          location.reload();
          return;
        }

        if (tab === 'global-indices') {
          document.getElementById('subindex-view').style.display = 'none';
          document.getElementById('home-view').style.display = 'flex';
          contentDiv.innerHTML = `<h2 style="text-align:left;">I3E Global Indices</h2>`;
          tableDiv.style.display = 'none';
          hideAllCharts();
          return;
        }

        if (tab === 'subindex') {
          showSubindex();
          return;
        }

        if (tab === 'forward') {
          showForward();
          return;
        }

        if (tab === 'data') {
          document.getElementById('subindex-view').style.display = 'none';
          document.getElementById('home-view').style.display = 'flex';
          contentDiv.innerHTML = `
            <p><a href="i3e_global.txt" target="_blank">DATA</a> - Download I3E global data (txt). Since 1990-01-01. Updated daily (${time}).</p>
            <p><a href="i3e_global_weighted.txt" target="_blank">DATA</a> - Download I3E global weighted data (txt). Since 1990-01-01. Updated daily (${time}).</p>
            <p><a href="i3e_countries.txt" target="_blank">DATA</a> - Download I3E country data (txt). Since 1990-01-01. Updated daily (${time}).</p>
            <p><a href="subindex.txt" target="_blank">DATA</a> - Download Subindex data (txt). Since 1990-01-01. Updated daily (${time}).</p>
            <p><a href="i3e_f_usa.txt" target="_blank">DATA</a> - Download I3E FORWARD (USA) data (txt). Since 2000-01-01. Updated daily (${time}).</p>
          `;
          tableDiv.style.display = 'none';
          hideAllCharts();
          return;
        }

        if (tab === 'research') {
          document.getElementById('subindex-view').style.display = 'none';
          document.getElementById('home-view').style.display = 'flex';
          contentDiv.innerHTML = `
            <h2>Research Papers</h2>
            <p><a href="I3E.pdf" target="_blank">Working paper</a> - I3E Technical Note.</p>
            <p><a href="I3E_and_alternatives.pdf" target="_blank">Working paper</a> - Comparison I3E, WUI, EPU and WIX.</p>
          `;
          tableDiv.style.display = 'none';
          hideAllCharts();
          return;
        }

        if (tab === 'contact') {
          document.getElementById('subindex-view').style.display = 'none';
          document.getElementById('home-view').style.display = 'flex';
          contentDiv.innerHTML = `
            <p>
              Miguel Angel AriÃ±o <br>
              Professor, Managerial Decision Sciences <br>
              IESE Business School <br>
              <a href="https://www.iese.edu/es/claustro-investigacion/claustro/miguel-angel-arino/" target="_blank" style="color:#FF3B30;">Website</a><br>
              <br>
              Roberto Garcia-Castro <br>
              Professor, Managerial Decision Sciences <br>
              IESE Business School <br>
              <a href="https://www.iese.edu/es/claustro-investigacion/claustro/roberto-garcia-castro/" target="_blank" style="color:#FF3B30;">Website</a><br>
              <br>
              IESE Business School <br>
              <a href="https://www.iese.edu" target="_blank" style="color:#FF3B30;">Website</a><br>
            </p>
          `;
          tableDiv.style.display = 'none';
          hideAllCharts();
          return;
        }
      });
    });

    // Sidebar: country chart selection
    // âœ… FIX: Do NOT switch tabs/views when clicking countries.
    // Only show the selected chart, and only show the home table if currentTab === "home".
    document.querySelectorAll('.sidebar a[data-country]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();

        const country = this.getAttribute('data-country');
        const containerId = `chart-${country}`;

        // Show/hide the home table depending on active tab
        const tableDiv = document.getElementById('table-container');
        if (tableDiv) {
          tableDiv.style.display = (currentTab === "home") ? "block" : "none";
        }

        // Do NOT touch home-view/subindex-view displays here.
        // Just switch chart.
        hideAllCharts();
        const chartDiv = document.getElementById(containerId);
        if (chartDiv) {
          chartDiv.style.display = 'block';
          chartDiv.scrollIntoView({ behavior: 'smooth' });
          renderChart(containerId, country);

          if (window.Plotly) {
            setTimeout(() => { try { Plotly.Plots.resize(chartDiv); } catch(e) {} }, 0);
          }
        }
      });
    });

    // Initial render
    document.addEventListener("DOMContentLoaded", () => {
      currentTab = "home";
      renderChart("chart-global", "global");
    });

    // Resize helpers
    function resizeAllPlots() {
      if (!window.Plotly) return;
      document.querySelectorAll('.plot-container').forEach(function (el) {
        try { Plotly.Plots.resize(el); } catch(e) {}
      });
    }
    window.addEventListener('resize', resizeAllPlots);
    window.addEventListener('orientationchange', function () { setTimeout(resizeAllPlots, 150); });
    window.addEventListener('load', function () { setTimeout(resizeAllPlots, 0); });
  </script>
</body>
</html>
